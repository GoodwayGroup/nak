function merge(e,r){for(var o=[];e.length>0&&r.length>0;)e[0]>r[0]?o.push(r.shift()):o.push(e.shift());return o=o.concat(e,r)}function help(){console.error("Usage: [options] 'PATTERN' ['REPLACEMENT'] 'PATH' \n"),console.error("Options:");for(var e=0,r=schema[0];schema.length>e;e++,r=schema[e]){var o=(r[0]?"-"+r[0]+(r[1]?"|":""):"   ")+(r[1]?"--"+r[1]:""),i=o+(-1!=r[2].indexOf(":")?" Â«valueÂ»":"");i+=20>i.length?Array(20-i.length).join(" "):"",console.error("	"+(-1!=r[2].indexOf("!")?"*":" ")+(-1!=r[2].indexOf("+")?"+":" ")+i+"	"+r[3])}process.exit(0)}function setExclusions(e){var r=dirExclusions=[];options.pathToNakignore&&(r=fs.readFileSync(options.pathToNakignore,"utf-8"));try{dirExclusions=fs.readFileSync(e+"/.nakignore","utf-8")}catch(o){}var i=r+"\n"+dirExclusions+"\n"+(void 0!==options.ignore?options.ignore:"");i.length&&(options.exclusions=i.split(/\r?\n/).filter(function(e){return!!e&&/^[^#]/.test(e)}),options.exclusionsLength=options.exclusions.length)}function makeQuery(e,r){var o="g";options.literal&&(e=ignorer.escapeRegExp(e)),options.ignoreCase&&(o+="i"),options.wordRegexp&&(e="\\b(?:"+e+")\\b"),options.query=RegExp(e,o),r&&(options.replacement=r)}var fs=require("fs");isbinaryfile=function(e,r){if(void 0===r){var o=e;e=fs.readFileSync(o),r=fs.statSync(o).size}var i=0,n=r>1024?1024:r;if(0==r)return!1;if(r>=3&&239==e[0]&&187==e[1]&&191==e[2])return 0;for(var t=0;n>t;t++){if(t>32&&100*i/n>10)return!0;if("0"==e[t])return!0;if((7>e[t]||e[t]>14)&&(32>e[t]||e[t]>127)){if(e[t]>191&&224>e[t]&&n>t+1){if(t++,192>e[t])continue}else if(e[t]>223&&239>e[t]&&n>t+2&&(t++,192>e[t]&&192>e[t+1])){t++;continue}i++}}return 100*i/n>10?!0:!1};var mergesort=module.exports=function(e){var r=e.length;if(2>r)return e;var o=Math.ceil(r/2);return merge(mergesort(e.slice(0,o)),mergesort(e.slice(o)))},ignorer={};module.exports=ignorer;var makeRules=ignorer.makeRules=function(e,r){for(var o=[],i=0,n=function(e){return RegExp(escapeRegExp(e).replace(/\\\*/g,".?"))};r>i;)o.push(n(e[i++]));return o},isIgnored=ignorer.isIgnored=function(e,r,o,i){if(!i&&(/^\.\w/.test(o)||/\/\.\w/.test(o)))return!0;for(var n=0;r>n;)if(e[n++].test(o))return!0;return!1},escapeRegExp=ignorer.escapeRegExp=function(e){return e.replace(/([\/'*+?|()\[\]{}.^$])/g,"\\$1")},makeWildcardRegExp=ignorer.makeWildcardRegExp=function(e,r){return e?(e=e.replace(/\s/g,""),e=escapeRegExp(e),e=e.replace(/\\\*/g,".*"),e=e.replace(/\\\?/g,"."),r?(e=e.replace(/,/g,"|"),e=RegExp("(?:"+e+")")):e):""},parser={};module.exports=parser;var schema=[["l","list","","list files encountered"],["H","hidden","","search hidden files and directories (default off)"],["c","color","","adds color to results  (default off)"],["a","pathToNakignore",":","path to an additional nakignore file"],["m","maxdepth",":","the maximum depth of the search"],["q","literal","","do not parse PATTERN as a regular expression; match it literally"],["w","wordRegexp","","only match whole words"],["i","ignoreCase","","match case insensitively"],["G","fileSearch",":","comma-separated list of wildcard files to only search on"],["d","ignore",":","comma-separated list of wildcard files to additionally ignore"],["p","piped","","indicates filenames are being piped in (like, from ag or find)"]],parseArgs=parser.parseArgs=function(e){2!=process.argv.length||e?void 0!==e&&(process.argv=e):help();var r=[],o={};o.args=[];for(var i=0,n=process.argv[0],t=process.argv.length;t>i;i++,n=process.argv[i])"-"==n.charAt(0)?"-"==n.charAt(1)?r.push("--",n.slice(2)):r=r.concat(n.split("").join("-").split("").slice(1)):r.push(n);for(;type=r.shift();)if("-"==type||"--"==type){var s=r.shift();("help"==s||"h"==s)&&help();for(var a=null,i=0,n=schema[0];schema.length>i;i++,n=schema[i])if(n[type.length-1]==s){a=n;break}var l=!0;-1==a[2].indexOf(":")||(l=r.shift())||(console.error("Option '"+type+s+"' expects a parameter!"),help());var c=a[1]||a[0];-1!=a[2].indexOf("+")?(o[c]=o[c]instanceof Array?o[c]:[],o[c].push(l)):o[c]=l,"function"==typeof a[4]&&a[4](l),a[2]=a[2].replace("!","")}else o.args.push(type);return void 0===e&&o.args.splice(0,2),o},walker={};module.exports=walker;var fs=require("fs"),_path=require("path"),StringDecoder=require("string_decoder").StringDecoder,decoder=new StringDecoder("utf8"),ignorer=ignorer,isBinaryFile=isbinaryfile,mergesort=mergesort,allPaths=[],allFiles={},ended=0,jobs=0,job=function(e){jobs+=e,1>e&&!tick&&(tick=1,process.nextTick(function(){tick=0,0>=jobs&&!ended&&(ended=1,finalizer())}))},tick=0;walker.walkdir=function(e,r,o,i){if(r.maxdepth=r.maxdepth||1/0,r.exclusions=r.exclusionsLength>0?ignorer.makeRules(r.exclusions,r.exclusionsLength):"",r.hidden=r.hidden||!1,finalizer=function(){if(r.list)o(mergesort(allPaths).join("\n"));else{for(var e=mergesort(Object.keys(allFiles)),n=0,t=e.length;t>n;n++){var s=e[n],a=fs.readFileSync(s);if(!isBinaryFile(a,allFiles[s].stat.size)){var l=decoder.write(a);if(r.query.lastIndex=0,r.query.test(l)){var c=l.match(r.query).length,p=c,f="";if(r.replacement){var u=l.replace(r.query,r.replacement);fs.writeFile(s,u,"utf8")}for(var l=l.split("\n"),g=0,d=l.length;p&&d>g;g++)r.query.lastIndex=0,r.query.test(l[g])&&(f+="	"+(g+1)+": "+(r.replacement?l[g].replace(r.query,r.replacement):l[g])+"\n",p--);o(s,f,c,e)}}}i()}},statter=function(e,o){job(1);var i=function(i){job(-1),i.isFile()?r.list?allPaths.push(e):(allFiles[e]={},allFiles[e].stat=i):i.isDirectory()&&readdir(e,o)};i(fs.lstatSync(e))},readdir=function(e,o){if(!(o>=r.maxdepth)){var i=function(i){if(job(-1),!i)return"Permission error (or other failure) on: "+i;for(var n=i.length,t=0;n>t;){var s=i[t++],a=e+"/"+s;r.filesInclude.test(s)&&!ignorer.isIgnored(r.exclusions,r.exclusionsLength,a,r.hidden)&&statter(a,(o||0)+1)}};ignorer.isIgnored(r.exclusions,r.exclusionsLength,e,r.hidden)||(job(1),fs.readdir(e,function(e,r){e&&(console.error(e),process.exit(1)),i(r)}))}},r.piped)for(var n=e.split("\n"),t=0,s=n.length;s>t;t++)n[t].length&&statter(n[t]);else readdir(e,1)};var options=parser.parseArgs(),fs=require("fs"),path=require("path"),walkdir=walker.walkdir,ignorer=ignorer;if(options.piped)process.stdin.resume(),process.stdin.setEncoding("utf8"),options.args.length>1?makeQuery(options.args.shift(),options.args.shift()):makeQuery(options.args.shift()),process.stdin.on("data",function(e){options.piped=!0,walkdir(e,options,function(e,r){options.color?(console.log(fileColor,e),r=r.replace(query,textColor),console.log(matchColor,r)):(console.log(e),console.log(r))})});else{var fpath=path.resolve(options.args.pop()),replacement=null,query=null,fileColor="",textColor="",matchColor="";if(1==options.args.length?query=options.args.pop():2==options.args.length&&(replacement=options.args.pop(),query=options.args.pop()),options.color&&(fileColor="\n[36m%s[0m",textColor="[37;43m[0;90m",matchColor="[90m%s"),options.filesInclude=options.fileSearch?ignorer.makeWildcardRegExp(options.fileSearch,!0):{test:function(){return!0}},setExclusions(fpath),query){makeQuery(query,replacement);var matches=0,filecount=0;walkdir(fpath,options,function(e,r,o){options.color?(console.log(fileColor,e+":"),r=r.replace(options.query,textColor),console.log(matchColor,r)):(console.log(e+":"),console.log(r)),matches+=o,filecount++},function(){console.log("Found "+matches+(1==matches?" match":" matches")+" in "+filecount+(1==filecount?" file ":" files "))})}else options.list&&walkdir(fpath,options,function(e){console.log(e)})}