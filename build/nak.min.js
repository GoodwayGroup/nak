function setExclusions(e){var t=dirExclusions=[];options.pathToNakignore&&(t=fs.readFileSync(options.pathToNakignore,"utf-8"));try{dirExclusions=fs.readFileSync(e+"/.agignore","utf-8")}catch(n){}var r=t+"\n"+dirExclusions+"\n"+(options.ignore!==undefined?options.ignore:"");r.length&&(options.exclusions=r.split(/\r?\n/).filter(function(e){return!!e&&/^[^#]/.test(e)}),options.exclusionsLength=options.exclusions.length)}function makeQuery(e,t){var n="g";options.literal&&(e=ignorer.escapeRegExp(e)),options.ignoreCase&&(n+="i"),options.wordRegexp&&(e="\\b(?:"+e+")\\b"),options.query=new RegExp(e,n),t&&(options.replacement=t)}var fs=require("fs");isbinaryfile=function(e,t){if(t===undefined){var n=e;e=fs.readFileSync(n),t=fs.statSync(n).size}var r=0,i=t>1024?1024:t;if(t==0)return!1;if(t>=3&&e[0]==239&&e[1]==187&&e[2]==191)return 0;for(var s=0;s<i;s++){if(s>32&&r*100/i>10)return!0;if(e[s]=="0")return!0;if((e[s]<7||e[s]>14)&&(e[s]<32||e[s]>127)){if(e[s]>191&&e[s]<224&&s+1<i){s++;if(e[s]<192)continue}else if(e[s]>223&&e[s]<239&&s+2<i){s++;if(e[s]<192&&e[s+1]<192){s++;continue}}r++}}return r*100/i>10?!0:!1};var async={};module.exports=async,async.queue=function(e,t){var n=0,r={tasks:[],concurrency:t,saturated:null,empty:null,drain:null,push:function(e,n){e.constructor!==Array&&(e=[e]),e.forEach(function(e){r.tasks.push({data:e,callback:typeof n=="function"?n:null}),r.saturated&&r.tasks.length==t&&r.saturated(),process.nextTick(r.process)})},process:function(){if(n<r.concurrency&&r.tasks.length){var t=r.tasks.shift();r.empty&&r.tasks.length==0&&r.empty(),n+=1,e(t.data,function(){n-=1,t.callback&&t.callback.apply(t,arguments),r.drain&&r.tasks.length+n==0&&r.drain(),r.process()})}},length:function(){return r.tasks.length},running:function(){return n}};return r};var ignorer={};module.exports=ignorer;var makeRules=ignorer.makeRules=function(e,t){var n=[],r=0,i=function(e){return new RegExp(escapeRegExp(e).replace(/\\\*/g,".?"))};while(r<t)n.push(i(e[r++]));return n},isIgnored=ignorer.isIgnored=function(e,t,n,r){if(!r&&(/^\.\w/.test(n)||/\/\.\w/.test(n)))return!0;for(var i=0;i<t;i++)if(e[i].test(n))return!0;return!1},escapeRegExp=ignorer.escapeRegExp=function(e){return e.replace(/([\/'*+?|()\[\]{}.^$])/g,"\\$1")},makeWildcardRegExp=ignorer.makeWildcardRegExp=function(e,t){return e?(e=e.replace(/\s/g,""),e=escapeRegExp(e),e=e.replace(/\\\*/g,".*"),e=e.replace(/\\\?/g,"."),t?(e=e.replace(/,/g,"|"),e=new RegExp("(?:"+e+")"),e):e):""},parser={};module.exports=parser;var schema=[["l","list","","list files encountered"],["H","hidden","","search hidden files and directories (default off)"],["c","color","","adds color to results  (default off)"],["p","pathToNakignore",":","path to an additional nakignore file"],["m","maxdepth",":","the maximum depth of the search"],["q","literal","","do not parse PATTERN as a regular expression; match it literally"],["w","wordRegexp","","only match whole words"],["i","ignoreCase","","match case insensitively"],["G","fileSearch",":","comma-separated list of wildcard files to only search on"],["d","ignore",":","comma-separated list of wildcard files to additionally ignore"],["p","piped","","indicates filenames are being piped in (like, from ag or find)"]],parseArgs=parser.parseArgs=function(){try{if(process.argv.length==2)throw"help";var e=[],t={};t.args=[];for(var n=0,r=process.argv[0];n<process.argv.length;n++,r=process.argv[n])r.charAt(0)=="-"?r.charAt(1)=="-"?e.push("--",r.slice(2)):e=e.concat(r.split("").join("-").split("").slice(1)):e.push(r);while(type=e.shift()){if(type!="-"&&type!="--"){t.args.push(type);continue}var i=e.shift();if(i=="help"||i=="h")throw"help";var s=null;for(var n=0,r=schema[0];n<schema.length;n++,r=schema[n])if(r[type.length-1]==i){s=r;break}if(!s)throw"Unknown option '"+type+i+"' encountered!";var o=!0;if(s[2].indexOf(":")!=-1&&!(o=e.shift()))throw"Option '"+type+i+"' expects a parameter!";var u=s[1]||s[0];s[2].indexOf("+")!=-1?(t[u]=t[u]instanceof Array?t[u]:[],t[u].push(o)):t[u]=o,typeof s[4]=="function"&&s[4](o),s[2]=s[2].replace("!","")}for(var n=0,r=schema[0];n<schema.length;n++,r=schema[n])if(r[2].indexOf("!")!=-1)throw"Option '"+(r[1]?"--"+r[1]:"-"+r[0])+"' is mandatory and was not given!";return t.args.splice(0,2),t}catch(a){if(a=="help"){console.log("Usage: [options] 'PATTERN' ['REPLACEMENT'] 'PATH' \n"),console.log("Options:");for(var n=0,r=schema[0];n<schema.length;n++,r=schema[n]){var f=(r[0]?"-"+r[0]+(r[1]?"|":""):"   ")+(r[1]?"--"+r[1]:""),l=f+(r[2].indexOf(":")!=-1?" Â«valueÂ»":"");l+=l.length<20?(new Array(20-l.length)).join(" "):"",console.log("	"+(r[2].indexOf("!")!=-1?"*":" ")+(r[2].indexOf("+")!=-1?"+":" ")+l+"	"+r[3])}process.exit(0)}console.error(a),console.error("Use  the '-h|--help' option for usage details."),process.exit(1)}},walker={};module.exports=walker;var fs=require("fs"),_path=require("path"),StringDecoder=require("string_decoder").StringDecoder,decoder=new StringDecoder("utf8");ignorer=ignorer,isBinaryFile=isbinaryfile,async=async,allPaths=[],allFiles={},pathIdx=0,ended=0,jobs=0,job=function(e){jobs+=e,e<1&&!tick&&(tick=1,process.nextTick(function(){tick=0,jobs<=0&&!ended&&(ended=1,finalizer())}))},tick=0,q=async.queue(function(e,t){e.type=="replacement"?fs.writeFile(e.path,e.replacement,"utf8",t):fs.readFile(e.path,t)},225),walker=walker.exports=function(e,t,n){t=t||{},t.maxdepth=t.maxdepth||Infinity,t.exclusions=t.exclusionsLength>0?ignorer.makeRules(t.exclusions,t.exclusionsLength):"",t.hidden=t.hidden||!1,finalizer=function(){if(t.list)n(r(allPaths).join("\n"));else{var e=r(Object.keys(allFiles)),i=e.length;for(var s=0;s<i;s++){var o=e[s],u=allFiles[o].contents,a="",f=0,l=-1,c="",h="",p=u.match(t.query).length,d=p,u=u.split("\n");if(t.replacement)var v=allFiles[o].replacedContents;for(var m=0,g=u.length;d&&m<g;m++)t.query.lastIndex=0,t.query.test(u[m])&&(a+=m+1+":"+(t.replacement?v[m]:u[m])+"\n",d--);n(o,a,p)}}};var r=function(e){var t=e.length;if(t<2)return e;var n=Math.ceil(t/2);return i(r(e.slice(0,n)),r(e.slice(n)))},i=function(e,t){var n=[];while(e.length>0&&t.length>0)e[0]>t[0]?n.push(t.shift()):n.push(e.shift());return n=n.concat(e,t),n},s=function(e,n){job(1);var r=function(i){job(-1),i.isFile()?t.list?allPaths.push(e):(job(1),u(e,i)):i.isDirectory()&&o(e,n)};r(fs.lstatSync(e))},o=function(e,n){if(n>=t.maxdepth)return;var r=function(r){job(-1);if(!r)return"Permission error (or other failure) on: "+r;var i;if(!(i=r.length))return;for(var o=0;o<i;o++){var u=r[o],a=e+"/"+u;t.filesInclude.test(u)&&!ignorer.isIgnored(t.exclusions,t.exclusionsLength,a,t.hidden)&&s(a,(n||0)+1)}};ignorer.isIgnored(t.exclusions,t.exclusionsLength,e,t.hidden)||(job(1),fs.readdir(e,function(e,t){e&&(console.error(e),process.exit(1)),r(t)}))},u=function(e,n){q.push({type:"query",path:e},function(r,i){r&&(console.error(r),process.exit(1)),job(-1);if(!isBinaryFile(i,n.size)){var s=decoder.write(i);t.query.lastIndex=0;if(t.query.test(s)){allFiles[e]={},allFiles[e].contents=s;if(t.replacement){var o=s.replace(t.query,t.replacement);allFiles[e].replacedContents=o.split("\n"),q.push({type:"replacement",replacement:o,path:e},function(e){e&&(console.error(e),process.exit(1)),job(-1)})}}}})};if(t.piped){var a=e.split("\n");for(var f=0,l=a.length;f<l;f++)a[f].length&&s(a[f])}else o(e,1)};var options=parser.parseArgs(),fs=require("fs"),path=require("path"),walk=walker,ignorer=require("../lib/ignorer");if(options.piped)process.stdin.resume(),process.stdin.setEncoding("utf8"),options.args.length>1?makeQuery(options.args.shift(),options.args.shift()):makeQuery(options.args.shift()),process.stdin.on("data",function(e){options.piped=!0,walk(e,options,function(e,t){options.color?(console.log(fileColor,e),t=t.replace(query,textColor),console.log(matchColor,t)):(console.log(e),console.log(t))})});else{var fpath=path.resolve(options.args.pop()),replacement=null,query=null,fileColor="",textColor="",matchColor="";options.args.length==1?query=options.args.pop():options.args.length==2&&(replacement=options.args.pop(),query=options.args.pop()),options.color&&(fileColor="\n[36m%s[0m",textColor="[37;43m[0;90m",matchColor="[90m%s"),options.filesInclude=options.fileSearch?ignorer.makeWildcardRegExp(options.fileSearch,!0):new RegExp(".*"),setExclusions(fpath);if(query){makeQuery(query,replacement);var matches=0,filecount=0;walk(fpath,options,function(e,t,n){options.color?(console.log(fileColor,e+":"),t=t.replace(options.query,textColor),console.log(matchColor,t)):(console.log(e+":"),console.log(t)),matches+=n,filecount++}),process.on("exit",function(){console.log("Found %d matches in %d files",matches,filecount)})}else options.list&&walk(fpath,options,function(e){console.log(e)})}