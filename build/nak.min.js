function merge(e,t){var n=[];while(e.length>0&&t.length>0)e[0]>t[0]?n.push(t.shift()):n.push(e.shift());return n=n.concat(e,t),n}function help(){console.error("Usage: [options] 'PATTERN' ['REPLACEMENT'] 'PATH' \n"),console.error("Options:");for(var e=0,t=schema[0];e<schema.length;e++,t=schema[e]){var n=(t[0]?"-"+t[0]+(t[1]?"|":""):"   ")+(t[1]?"--"+t[1]:""),r=n+(t[2].indexOf(":")!=-1?" Â«valueÂ»":"");r+=r.length<20?(new Array(20-r.length)).join(" "):"",console.error("	"+(t[2].indexOf("!")!=-1?"*":" ")+(t[2].indexOf("+")!=-1?"+":" ")+r+"	"+t[3])}process.exit(0)}function setExclusions(e){var t=dirExclusions=[];options.pathToNakignore&&(t=fs.readFileSync(options.pathToNakignore,"utf-8"));try{dirExclusions=fs.readFileSync(e+"/.nakignore","utf-8")}catch(n){}var r=t+"\n"+dirExclusions+"\n"+(options.ignore!==undefined?options.ignore:"");r.length&&(options.exclusions=r.split(/\r?\n/).filter(function(e){return!!e&&/^[^#]/.test(e)}),options.exclusionsLength=options.exclusions.length)}function makeQuery(e,t){var n="g";options.literal&&(e=ignorer.escapeRegExp(e)),options.ignoreCase&&(n+="i"),options.wordRegexp&&(e="\\b(?:"+e+")\\b"),options.query=new RegExp(e,n),t&&(options.replacement=t)}var fs=require("fs");isbinaryfile=function(e,t){if(t===undefined){var n=e;e=fs.readFileSync(n),t=fs.statSync(n).size}var r=0,i=t>1024?1024:t;if(t==0)return!1;if(t>=3&&e[0]==239&&e[1]==187&&e[2]==191)return 0;for(var s=0;s<i;s++){if(s>32&&r*100/i>10)return!0;if(e[s]=="0")return!0;if((e[s]<7||e[s]>14)&&(e[s]<32||e[s]>127)){if(e[s]>191&&e[s]<224&&s+1<i){s++;if(e[s]<192)continue}else if(e[s]>223&&e[s]<239&&s+2<i){s++;if(e[s]<192&&e[s+1]<192){s++;continue}}r++}}return r*100/i>10?!0:!1};var mergesort=module.exports=function(e){var t=e.length;if(t<2)return e;var n=Math.ceil(t/2);return merge(mergesort(e.slice(0,n)),mergesort(e.slice(n)))},ignorer={};module.exports=ignorer;var makeRules=ignorer.makeRules=function(e,t){var n=[],r=0,i=function(e){return new RegExp(escapeRegExp(e).replace(/\\\*/g,".?"))};while(r<t)n.push(i(e[r++]));return n},isIgnored=ignorer.isIgnored=function(e,t,n,r){if(!r&&(/^\.\w/.test(n)||/\/\.\w/.test(n)))return!0;var i=0;while(i<t)if(e[i++].test(n))return!0;return!1},escapeRegExp=ignorer.escapeRegExp=function(e){return e.replace(/([\/'*+?|()\[\]{}.^$])/g,"\\$1")},makeWildcardRegExp=ignorer.makeWildcardRegExp=function(e,t){return e?(e=e.replace(/\s/g,""),e=escapeRegExp(e),e=e.replace(/\\\*/g,".*"),e=e.replace(/\\\?/g,"."),t?(e=e.replace(/,/g,"|"),e=new RegExp("(?:"+e+")"),e):e):""},parser={};module.exports=parser;var schema=[["l","list","","list files encountered"],["H","hidden","","search hidden files and directories (default off)"],["c","color","","adds color to results  (default off)"],["a","pathToNakignore",":","path to an additional nakignore file"],["m","maxdepth",":","the maximum depth of the search"],["q","literal","","do not parse PATTERN as a regular expression; match it literally"],["w","wordRegexp","","only match whole words"],["i","ignoreCase","","match case insensitively"],["G","fileSearch",":","comma-separated list of wildcard files to only search on"],["d","ignore",":","comma-separated list of wildcard files to additionally ignore"],["p","piped","","indicates filenames are being piped in (like, from ag or find)"]],parseArgs=parser.parseArgs=function(){process.argv.length==2&&help();var e=[],t={};t.args=[];for(var n=0,r=process.argv[0],i=process.argv.length;n<i;n++,r=process.argv[n])r.charAt(0)=="-"?r.charAt(1)=="-"?e.push("--",r.slice(2)):e=e.concat(r.split("").join("-").split("").slice(1)):e.push(r);while(type=e.shift()){if(type!="-"&&type!="--"){t.args.push(type);continue}var s=e.shift();(s=="help"||s=="h")&&help();var o=null;for(var n=0,r=schema[0];n<schema.length;n++,r=schema[n])if(r[type.length-1]==s){o=r;break}var u=!0;o[2].indexOf(":")!=-1&&!(u=e.shift())&&(console.error("Option '"+type+s+"' expects a parameter!"),help());var a=o[1]||o[0];o[2].indexOf("+")!=-1?(t[a]=t[a]instanceof Array?t[a]:[],t[a].push(u)):t[a]=u,typeof o[4]=="function"&&o[4](u),o[2]=o[2].replace("!","")}return t.args.splice(0,2),t},walker={};module.exports=walker;var fs=require("fs"),_path=require("path"),StringDecoder=require("string_decoder").StringDecoder,decoder=new StringDecoder("utf8"),ignorer=ignorer,isBinaryFile=isbinaryfile,mergesort=mergesort,allPaths=[],allFiles={},ended=0,jobs=0,job=function(e){jobs+=e,e<1&&!tick&&(tick=1,process.nextTick(function(){tick=0,jobs<=0&&!ended&&(ended=1,finalizer())}))},tick=0;walker.walkdir=function(e,t,n){t.maxdepth=t.maxdepth||Infinity,t.exclusions=t.exclusionsLength>0?ignorer.makeRules(t.exclusions,t.exclusionsLength):"",t.hidden=t.hidden||!1,finalizer=function(){if(t.list)n(mergesort(allPaths).join("\n"));else{var e=mergesort(Object.keys(allFiles));for(var r=0,i=e.length;r<i;r++){var s=e[r],o=fs.readFileSync(s);if(!isBinaryFile(o,allFiles[s].stat.size)){var u=decoder.write(o);t.query.lastIndex=0;if(t.query.test(u)){var a=u.match(t.query).length,f=a,u=u.split("\n"),l="";for(var c=0,h=u.length;f&&c<h;c++)t.query.lastIndex=0,t.query.test(u[c])&&(l+=c+1+":"+(t.replacement?replacedContents[c]:u[c])+"\n",f--);n(s,l,a)}}}}},statter=function(e,n){job(1);var r=function(i){job(-1),i.isFile()?t.list?allPaths.push(e):(allFiles[e]={},allFiles[e].stat=i):i.isDirectory()&&readdir(e,n)};r(fs.lstatSync(e))},readdir=function(e,n){if(n>=t.maxdepth)return;var r=function(r){job(-1);if(!r)return"Permission error (or other failure) on: "+r;var i=r.length,s=0;while(s<i){var o=r[s++],u=e+"/"+o;t.filesInclude.test(o)&&!ignorer.isIgnored(t.exclusions,t.exclusionsLength,u,t.hidden)&&statter(u,(n||0)+1)}};ignorer.isIgnored(t.exclusions,t.exclusionsLength,e,t.hidden)||(job(1),fs.readdir(e,function(e,t){e&&(console.error(e),process.exit(1)),r(t)}))};if(t.piped){var r=e.split("\n");for(var i=0,s=r.length;i<s;i++)r[i].length&&statter(r[i])}else readdir(e,1)};var options=parser.parseArgs(),fs=require("fs"),path=require("path"),walkdir=walker.walkdir,ignorer=require("../lib/ignorer");if(options.piped)process.stdin.resume(),process.stdin.setEncoding("utf8"),options.args.length>1?makeQuery(options.args.shift(),options.args.shift()):makeQuery(options.args.shift()),process.stdin.on("data",function(e){options.piped=!0,walkdir(e,options,function(e,t){options.color?(console.log(fileColor,e),t=t.replace(query,textColor),console.log(matchColor,t)):(console.log(e),console.log(t))})});else{var fpath=path.resolve(options.args.pop()),replacement=null,query=null,fileColor="",textColor="",matchColor="";options.args.length==1?query=options.args.pop():options.args.length==2&&(replacement=options.args.pop(),query=options.args.pop()),options.color&&(fileColor="\n[36m%s[0m",textColor="[37;43m[0;90m",matchColor="[90m%s"),options.filesInclude=options.fileSearch?ignorer.makeWildcardRegExp(options.fileSearch,!0):{test:function(){return!0}},setExclusions(fpath);if(query){makeQuery(query,replacement);var matches=0,filecount=0;walkdir(fpath,options,function(e,t,n){options.color?(console.log(fileColor,e+":"),t=t.replace(options.query,textColor),console.log(matchColor,t)):(console.log(e+":"),console.log(t)),matches+=n,filecount++}),process.on("exit",function(){console.log("Found %d matches in %d files",matches,filecount)})}else options.list&&walkdir(fpath,options,function(e){console.log(e)})}